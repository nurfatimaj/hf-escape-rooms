---
listing: 
  id: room-table
  contents: rooms
  type: table
  fields: 
    - date
    - title
    - city
    - country
    - players
  field-display-names: 
    title: Room
    city: City
    country: Country
    players: Players
execute: 
  echo: false
  warning: false
  error: false
---

```{r}
#| label: room-table
#| include: false
#| cache: false

library(tidyverse)

room_list <- list.files('rooms', '.qmd', 
                        recursive = TRUE, full.names = TRUE)
names(room_list) <- basename(str_remove_all(room_list, '.qmd'))

room_yaml <- map(room_list, rmarkdown::yaml_front_matter)
room_yaml <- map(room_yaml, ~.x[c('title', 'date', 'long', 'lat', 'company')])

room_tbl <- map(room_yaml, as_tibble)
room_tbl <- bind_rows(room_tbl, .id = 'room')
room_tbl <- room_tbl %>% mutate(path = room_list[room])
room_tbl <- room_tbl %>% mutate(dt = parse_date_time(date, 'dmy HM'))
room_tbl <- room_tbl %>% mutate(date = format(dt, '%d %b %Y'))

room_tbl <- room_tbl %>% 
  mutate(linked_name = paste0("<b><a href='", path, 
                              "' target='_parent'>", title, "</a></b>"))

ojs_define(data = room_tbl)
```

```{ojs}
//| panel: input
//| classes: bg-white text-dark

viewof year_filter = Inputs.form({
  beg: Inputs.number([2023, Infinity], {step: 1, label: 'From', placeholder: new Date().getFullYear(), value: 2023}), 
  end: Inputs.number([2023, Infinity], {step: 1, label: 'to', placeholder: new Date().getFullYear(), value: new Date().getFullYear()}), 
}, 
{
  template: (inputs) => htl.html`<div class="row justify-content-between no-gutters">
    <div class="col">${inputs.beg}</div>
    <div class="col">${inputs.end}</div>
    </div>`
}); 
```

```{ojs}
//| panel: fill
//| dependson: room-table

filtered = transpose(data).filter(function(d) {
  return year_filter.beg <= new Date(d.date).getFullYear() && new Date(d.date).getFullYear() <= year_filter.end; 
})

width = '100%'; 
height = '500px'; 

roomMap = {
  // You'll often see Leaflet examples initializing a map like L.map('map'),
  // which tells the library to look for a div with the id 'map' on the page.
  // In Observable, we instead create a div from scratch in this cell, so it's
  // completely self-contained.
  let container = DOM.element('div', { style: `width:${width};height:${height}` });
  
  // Note that I'm yielding the container pretty early here: this allows the
  // div to be placed on the page. This is important, because Leaflet uses
  // the div's .offsetWidth and .offsetHeight to size the map. If I were
  // to only return the container at the end of this method, Leaflet might
  // get the wrong idea about the map's size.
  yield container;
  
  // Now we create a map object and add a layer to it.
  let map = L.map(container);
  let osmLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
  
  var rooms = L.featureGroup(); 
  for (var i = 0; i < filtered.length; i++) {
    let room = L.marker([filtered[i].lat, filtered[i].long]); 
    room.bindPopup(filtered[i].linked_name); 
    rooms.addLayer(room);
  }
  
  map.addLayer(rooms); 
  map.fitBounds(rooms.getBounds(), {maxZoom: 7});
}
```

::: {#room-table}
:::
