---
format: 
  dashboard:
    orientation: columns

listing: 
  id: room-table
  contents: rooms
  type: table
  fields: 
    - date
    - title
    - rating
    - city
    - country
    - players
    - completion-time
  field-display-names: 
    title: Room
    rating: Rating
    city: City
    country: Country
    players: Players
    completion-time: Completion time
  sort: 
    - date desc
  sort-ui: [date, title, rating, city, country, completion-time]
    
execute: 
  echo: false
  warning: false
  error: false
---

# Overview

##  {.sidebar}

```{r}
#| label: room-table
#| include: false
#| cache: false

library(tidyverse)

room_list <- list.files('rooms', '.qmd', 
                        recursive = TRUE, full.names = TRUE)
names(room_list) <- basename(str_remove_all(room_list, '.qmd'))

room_yaml <- map(room_list, rmarkdown::yaml_front_matter)
room_yaml <- map(room_yaml, ~.x[c('title', 'date', 'long', 'lat', 'company', 'country', 'completion-time', 'rating')])
room_yaml <- lapply(room_yaml, function(room) {
  lapply(room, function(yaml) {
    if (is.null(yaml)) {
      return(NA)
    } else {
      return(yaml)
    }
  })
})

room_tbl <- map(room_yaml, as_tibble)
room_tbl <- bind_rows(room_tbl, .id = 'room')
room_tbl <- room_tbl %>% mutate(path = room_list[room])
room_tbl <- room_tbl %>% mutate(dt = parse_date_time(date, 'dmy HM'))
room_tbl <- room_tbl %>% mutate(date = format(dt, '%d %b %Y'), 
                                year = year(dt), 
                                time_min = str_extract(`completion-time`, '[[:digit:]]+'), 
                                time_min = as.numeric(time_min), 
                                time_min = case_when(
                                  str_detect(`completion-time`, 'min') ~ time_min, 
                                  str_detect(`completion-time`, 'h|hour') ~ time_min * 60, 
                                  .default = NA))

room_tbl <- room_tbl %>% 
  mutate(linked_name = paste0("<b><a href='", path, 
                              "' target='_parent'>", title, "</a></b>"))

ojs_define(data = room_tbl)
```

```{ojs}
//| panel: input
//| classes: bg-white text-dark

viewof year_filter = Inputs.form({
  beg: Inputs.number([2023, Infinity], {step: 1, label: 'From', placeholder: new Date().getFullYear(), value: 2023}), 
  end: Inputs.number([2023, Infinity], {step: 1, label: 'to', placeholder: new Date().getFullYear(), value: new Date().getFullYear()}), 
}, 
{
  template: (inputs) => htl.html`<div class="row justify-content-between no-gutters">
    <div class="col">${inputs.beg}</div>
    <div class="col">${inputs.end}</div>
    </div>`
}); 

viewof by_variable = Inputs.select(new Map([['Country', 'country'], ['Rating', 'rating'], ['Year', 'year'], ['Company', 'company'], ['Completion time', 'time_min']]), {value: 'country', label: 'By'});
```

## Column {width="60%"}

```{ojs}
//| panel: fill

filtered = transpose(data).filter(function(d) {
  return year_filter.beg <= new Date(d.date).getFullYear() && new Date(d.date).getFullYear() <= year_filter.end; 
})

width = '100%'; 
height = '500px'; 

groups = Array.from(new Set(filtered.map(d => d?.[by_variable]))).sort()
colors = d3.scaleOrdinal(d3.schemeTableau10).domain(groups)

roomMap = {
  // You'll often see Leaflet examples initializing a map like L.map('map'),
  // which tells the library to look for a div with the id 'map' on the page.
  // In Observable, we instead create a div from scratch in this cell, so it's
  // completely self-contained.
  let container = DOM.element('div', { style: `width:${width};height:${height}` });
  
  // Note that I'm yielding the container pretty early here: this allows the
  // div to be placed on the page. This is important, because Leaflet uses
  // the div's .offsetWidth and .offsetHeight to size the map. If I were
  // to only return the container at the end of this method, Leaflet might
  // get the wrong idea about the map's size.
  yield container;
  
  // Now we create a map object and add a layer to it.
  let map = L.map(container);
  let osmLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
  
  var rooms = L.featureGroup(); 
  for (var i = 0; i < filtered.length; i++) {
    var c = colors(filtered[i]?.[by_variable]);
    let room = L.circleMarker([filtered[i].lat, filtered[i].long], {color: c, fillColor:c}); 
    room.bindPopup(filtered[i].linked_name); 
    rooms.addLayer(room);
  }
  
  map.addLayer(rooms); 
  map.fitBounds(rooms.getBounds(), {maxZoom: 7});
}
```

## Column {width="40%"}

```{ojs}

Plot.rectY(filtered, 
  Plot.binX(
    {y: "count"}, 
    {x: "year", fill: by_variable, thresholds: 'auto'}
  ))
  .plot({
    color: {legend: true},
    marks: [
      Plot.frame(),
    ]
  }
)
```

```{ojs}
Plot.lineY(filtered, 
    Plot.binX(
      {y: "mean"}, 
      {x: "year", y: "rating", stroke: by_variable, strokeWidth: 3}
    )
  )
  .plot({
    color: {legend: true},
    marks: [
      Plot.frame(),
      Plot.dot(filtered, 
      {x: "year", y: "rating", color: by_variable, fill: by_variable}
    )
    ]
  }
)
```

# List

::: {#room-table}
:::
